<html>
<head>
    <style>
        body {
            background-color: gray;
        }
        .map {
            background-color: white;
        }
        circle {
            fill: red;
        }
        .layer {
            position: absolute;
        }
        text {
            font: 14px sans-serif;
            fill: black;
        }
    </style>
</head>
<script type="text/javascript">
    var Map = function() {
        return {
            debug: false,
            width: Math.max(960, window.innerWidth),
            height: Math.max(500, window.innerHeight),
            svg: null,
            graph: null,
            radius: 10,
            createSubRedditNode: function(id) {
                this.graph.data.push({ id: id });
                // console.log(this.graph.data);
                this.updateSimulation();
            },
            init: function() {
                this.svg = d3.select("body")
                .append("svg")
                    .attr("class", "map")
                    .style("width", this.width + "px")
                    .style("height", this.height + "px");
                    
                this.graph =
                    {
                        data: [],
                        links: []
                    };

                var map = d3.select(".map");

                // var linkForce = d3.forceLink()
                //     .id(link => link.id)
                //     .distance(50)
                //     .strength(link => .01);
                
                this.simulation = d3
                    .forceSimulation()
                    // .force("link", linkForce)
                    .force("charge", d3.forceManyBody()
                        .strength(.2)
                        )
                    .force("collision", d3.forceCollide(this.radius*4))
                    .force("center", d3.forceCenter(this.width / 2, this.height / 2))
                    ;
                
                // this.linkGroup = map.append("g")
                //     .attr("class", "links");
                this.nodeGroup = map.append("g")
                    .attr("class", "nodes");
                
                this.updateSimulation();
            },
            dragDrop: null,
            linkElements: null,
            nodeElements: null,
            linkGroup: null,
            nodeGroup: null,
            updateGraph: function() {
                this.nodeElements = this.nodeGroup.selectAll("g")
                    .data(this.graph.data);
                
                this.nodeElements.exit().remove();

                var nodeEnter = this.nodeElements.enter()
                    .append("g")
                        .attr("x", this.width / 2)
                        .attr("y", this.height / 2)
                        ;
                nodeEnter
                    .append("circle")
                        .attr("id", function(d) { return d.id; })
                        .attr("data-id", d => d.id)
                        .attr("stroke", "black")
                        .attr("stroke-width", "1px")
                        .attr("r", this.radius);
                nodeEnter
                    .append("text")
                        .attr("y", -15)
                        .attr("x", d => -((d.id.length * 12) / 4))
                        .text(d => d.id)
                    ;

                this.nodeElements = nodeEnter.merge(this.nodeElements);
            },
            updateSimulation: function() {    
                this.updateGraph();
                this.simulation.nodes(this.graph.data).on("tick", () => {
                
                    this.nodeElements
                        .attr('transform', node => "translate(" + node.x + "," + node.y + ")")
                        ;
                
                    // this.linkElements
                    //     .attr("x1", link => link.source.x)
                    //     .attr("y1", link => link.source.y)
                    //     .attr("x2", link => link.target.x)
                    //     .attr("y2", link => link.target.y);
                
                });
            
                // this.simulation.force("link").links(this.graph.links);
                this.simulation.alphaTarget(20).restart();
            }
        }
    }();
    var subredditList = {};
    document.addEventListener("DOMContentLoaded", function(event) {
        Map.init();
        requestComments();
    });
    var frequencySeconds = 60;
    function getSeconds(seconds) {
        return seconds * 1000;
    }
    function getMilliseconds(milliseconds) {
        return milliseconds * 1000;
    }
    function requestComments() {
        const Http = new XMLHttpRequest();
        const baseUrl = "https://api.pushshift.io/reddit/comment/search";
        var currentTime = new Date().getTime();
        currentTime -= getSeconds(frequencySeconds);
        console.log(new Date(currentTime));
        const afterFilter = "after=" + parseInt(currentTime / 1000);
        var url = baseUrl + "?" + afterFilter;
        Http.open("GET", url);
        Http.send();
        Http.onreadystatechange = function() {
            if(this.readyState === 4 && this.status === 200) {
                var returnJson = JSON.parse(Http.responseText);
                // console.log(Http.responseText);
                console.log(returnJson);
                returnJson.data.forEach(function(el) {
                    var subredditRecord = subredditList[el.subreddit];
                    if(!subredditRecord) {
                        Map.createSubRedditNode(el.subreddit);
                        subredditList[el.subreddit] = { name: el.subreddit, count: 0, users: [ ] };
                        subredditRecord = subredditList[el.subreddit];
                    } 
                    subredditRecord.count += 1;
                    subredditRecord.users.push({ date: new Date(el.created_utc*1000), author: el.author, comment: el.body });
                });
                console.log(Object.keys(subredditList).length);
                console.log(subredditList);
            }
        }

        // setTimeout(requestComments, getSeconds(frequencySeconds));
    }
</script>
<body>
    <header>Redrunn</header>
</body> 
<script src="./node_modules/d3/dist/d3.min.js" type="text/javascript"></script>
<!-- <script src="./Scripts/Constants.js" type="text/javascript"></script>
<script src="./Map.js" type="text/javascript"></script> -->
</html>